<%= form_for metadata_builder, :validate => true, :html => { :class => "field-mappings", :method => :post}, :url => "/metadata_builders/#{@object.metadata_builder.id}" do |f| %>
<%= render_flash_errors if flash[:error] %>
  <%= field_set_tag 'Map source metadata to XML' do %>
    Fill out the fields below to map your metadata to source.
  <% end %>
  <%= f.hidden_field :parent_repo, :value => "#{@object.id}" %>
  <% @object.metadata_builder.source_mappings.each do |mappings| %>
  <% root_val, parent_val = _structural_elements(mappings.first.last) %>
  <h3>Mappings for <%= mappings.first.last.gsub(@object.version_control_agent.working_path, "") %></h3>
    <%= f.hidden_field :source_file, :value => "#{mappings.first.last}" %>
    <%= content_tag :div, :class => "field" do -%>
      <%= f.label "field_mappings[#{mappings.first.last}][root_element][mapped_value]", "Root element:" %>
      <%= f.text_field "field_mappings[#{mappings.first.last}][root_element][mapped_value]", :value => "#{root_val}" %>
      <%= content_tag(:div, "Root element of the XML schema generated -- defaults to \"root\" if left blank.", :class => "field-tip") %>
    <% end -%>
    <%= content_tag :div, :class => "field" do -%>
      <%= f.label "field_mappings[#{mappings.first.last}][child_element][mapped_value]", "Child element of root, applied per row (optional):" %>
      <%= f.text_field "field_mappings[#{mappings.first.last}][child_element][mapped_value]", :value => "#{parent_val}" %>
      <%= content_tag(:div, "Optional -- Parent of each row of values in metadata source spreadsheet; Child of the root element.", :class => "field-tip") %>
    <% end -%>
    <% mappings.drop(1).each do |p| %>
      <% val = @object.metadata_builder.field_mappings.nil? ? p.first : @object.metadata_builder.field_mappings["#{mappings.first.last}"]["#{p.first}"]["mapped_value"]  %>
        <%= content_tag :div, :class => "field" do -%>
        <%= f.label "field_mappings[#{mappings.first.last}][#{p.first}][mapped_value]", "\"#{p.first}\" should map to:" %>
        <%= f.text_field "field_mappings[#{mappings.first.last}][#{p.first}][mapped_value]", :value => "#{val}" %>
        <%= content_tag(:div, "Example values from source: #{p.last.to_s}", :class => "field-tip") %>
      <% end -%>
    <% end -%>
    <%= f.hidden_field "xml[#{mappings.first.last}]", :value => "#{mappings}" %>
  <% end -%>
  <%= content_tag(:div, f.submit, :class => "form-bottom") %>
<% end %>
